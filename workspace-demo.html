<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Leo Web Workspace Demo</title>
  <style>
    body {
      font-family: sans-serif;
      display: flex;
      height: 100vh;
      margin: 0;
    }

    #sidebar {
      width: 250px;
      background: #f3f3f3;
      border-right: 1px solid #ccc;
      overflow-y: auto;
      padding: 0.5em;
    }

    #main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    #toolbar {
      padding: 0.5em;
      background: #eee;
      border-bottom: 1px solid #ccc;
    }

    #editor {
      flex: 1;
      width: 100%;
      height: 100%;
      border: none;
      font-family: monospace;
      font-size: 14px;
      padding: 1em;
      box-sizing: border-box;
    }

    button {
      margin-right: 0.5em;
    }

    ul {
      list-style: none;
      padding-left: 1em;
    }

    li {
      cursor: pointer;
      margin: 0.2em 0;
    }

    li:hover {
      background: #ddd;
    }
  </style>
</head>

<body>
  <div id="sidebar">
    <button id="openWorkspace">ðŸ“‚ Open Workspace</button>
    <ul id="fileTree"></ul>
  </div>
  <div id="main">
    <div id="toolbar">
      <span id="currentFile">(no file opened)</span>
      <button id="saveFile">ðŸ’¾ Save</button>
    </div>
    <textarea id="editor" placeholder="Open a file to start editing..."></textarea>
  </div>

  <script>
    let workspaceHandle = null;
    let currentFileHandle = null;

    // --- UI Elements ---
    const openBtn = document.getElementById('openWorkspace');
    const saveBtn = document.getElementById('saveFile');
    const editor = document.getElementById('editor');
    const fileTree = document.getElementById('fileTree');
    const currentFileLabel = document.getElementById('currentFile');

    // --- Handlers ---
    openBtn.onclick = async () => {
      try {
        workspaceHandle = await window.showDirectoryPicker();
        console.log('Workspace opened:', workspaceHandle, workspaceHandle.name);
        fileTree.innerHTML = '';
        await buildTree(workspaceHandle, fileTree);
      } catch (err) {
        alert('Workspace access was denied or cancelled.');
        console.error(err);
      }
    };

    saveBtn.onclick = async () => {
      if (!currentFileHandle) return alert('No file is open.');
      const writable = await currentFileHandle.createWritable();
      await writable.write(editor.value);
      await writable.close();
      alert('File saved!');
    };

    // --- Helpers ---
    async function buildTree(dirHandle, parentEl) {
      for await (const [name, handle] of dirHandle.entries()) {
        const li = document.createElement('li');
        li.textContent = name;

        if (handle.kind === 'directory') {
          const subList = document.createElement('ul');
          li.appendChild(subList);
          li.onclick = (e) => {
            e.stopPropagation(); // prevent bubbling
            subList.style.display =
              subList.style.display === 'none' ? 'block' : 'none';
          };
          await buildTree(handle, subList);
        } else if (handle.kind === 'file') {
          li.onclick = async (e) => {
            e.stopPropagation();
            await openFile(handle);
          };
        }
        parentEl.appendChild(li);
      }
    }

    async function openFile(fileHandle) {
      currentFileHandle = fileHandle;
      const file = await fileHandle.getFile();
      const text = await file.text();
      editor.value = text;
      currentFileLabel.textContent = fileHandle.name;
    }
  </script>
</body>

</html>