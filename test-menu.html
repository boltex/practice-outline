<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pure JS App Menu with Keyboard</title>
    <style>
        body {
            margin: 0;
            font-family: sans-serif;
        }

        .menu {
            display: flex;
            background: #eee;
            border-bottom: 1px solid #ccc;
            position: relative;
            z-index: 10;
            user-select: none;
        }

        .submenu {
            display: none;
            flex-direction: column;
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            min-width: 160px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .submenu.visible {
            display: flex;
        }

        .menu-item {
            position: relative;
            padding: 5px 14px;
            cursor: default;
            white-space: nowrap;
        }

        .menu-item:hover {
            background: #cce;
        }

        .menu-item.active,
        .menu-item.sub-active {
            background: #bbd;
        }

        .menu-item.focused {
            outline: 1px dotted #444;
            background: #dde;
        }

        .menu-item.has-sub::after {
            content: "â–¶";
            font-size: 10px;
            float: right;
            margin-left: 8px;
            color: #666;
        }

        .menu:not(.submenu)>.menu-item {
            padding: 5px 16px;
        }
    </style>
</head>

<body>

    <script>
        const menuData = [
            {
                label: "File",
                entries: [
                    { label: "Open...", action: "open" },
                    {
                        label: "Export",
                        entries: [
                            { label: "As PDF...", action: "export_pdf" },
                            { label: "As Image...", action: "export_img" },
                        ],
                    },
                    { label: "Exit", action: "exit" },
                ],
            },
            {
                label: "Edit",
                entries: [
                    { label: "Undo", action: "undo" },
                    { label: "Redo", action: "redo" },
                    { label: "Cut", action: "cut" },
                    { label: "Copy", action: "copy" },
                    { label: "Paste", action: "paste" },
                ],
            },
            {
                label: "View",
                entries: [
                    { label: "Zoom In", action: "zoom_in" },
                    { label: "Zoom Out", action: "zoom_out" },
                    {
                        label: "Orientation",
                        entries: [
                            { label: "Portrait", action: "orient_portrait" },
                            { label: "Landscape", action: "orient_landscape" },
                        ],
                    },
                    { label: "Fullscreen", action: "fullscreen" },
                ],
            },
            {
                label: "Help",
                entries: [
                    { label: "Documentation", action: "docs" },
                    { label: "About", action: "about" },
                ],
            },
        ];

        let activeTopMenu = null;
        let focusedItem = null;
        const topLevelItems = [];
        const topLevelSubmenus = new Map();

        function buildMenu(entries, level = 0) {
            const menu = document.createElement("div");
            menu.className = "menu" + (level > 0 ? " submenu" : "");

            for (const entry of entries) {
                const item = document.createElement("div");
                item.className = "menu-item";
                item.textContent = entry.label;

                item.addEventListener("mouseenter", () => {
                    if (focusedItem && focusedItem !== item) {
                        focusedItem.classList.remove("focused");
                        focusedItem = null;
                    }
                });

                if (entry.entries) {
                    if (level > 0) item.classList.add("has-sub");
                    const sub = buildMenu(entry.entries, level + 1);
                    if (level === 0) {
                        document.body.appendChild(sub);
                        topLevelSubmenus.set(item, sub);
                    } else {
                        item.appendChild(sub);
                    }

                    if (level === 0) {
                        item.addEventListener("click", (e) => {
                            e.stopPropagation();
                            if (activeTopMenu === item) {
                                closeAllSubmenus();
                                activeTopMenu = null;
                            } else {
                                openTopMenu(item, sub, level);
                            }
                        });

                        item.addEventListener("mouseenter", () => {
                            if (activeTopMenu && activeTopMenu !== item) {
                                openTopMenu(item, sub, level);
                            }
                        });
                    } else {
                        item.addEventListener("mouseenter", () => {
                            positionSubmenu(item, sub, level);
                            sub.classList.add("visible");
                        });
                        item.addEventListener("mouseleave", (e) => {
                            const related = e.relatedTarget;
                            if (!related || (!item.contains(related) && !sub.contains(related))) {
                                sub.classList.remove("visible");
                            }
                        });
                    }
                } else if (entry.action) {
                    item.addEventListener("click", () => {
                        console.log("Action triggered:", entry.action);
                        closeAllSubmenus();
                        activeTopMenu = null;
                    });
                }

                if (level === 0) {
                    topLevelItems.push(item);
                }

                menu.appendChild(item);
            }

            return menu;
        }

        function openTopMenu(item, sub, level) {
            closeAllSubmenus();
            activeTopMenu = item;
            const targetSubmenu = sub || topLevelSubmenus.get(item);
            if (!targetSubmenu) return;
            positionSubmenu(item, targetSubmenu, level);
            targetSubmenu.classList.add("visible");
            item.classList.add("active");
            focusedItem = null;
        }

        function positionSubmenu(parentItem, submenu, level) {
            submenu.style.display = "flex";
            const rect = parentItem.getBoundingClientRect();
            const subRect = submenu.getBoundingClientRect();

            if (level === 0) {
                submenu.style.left = rect.left + "px";
                submenu.style.top = rect.bottom + "px";
            } else {
                const spaceRight = window.innerWidth - rect.right;
                const spaceLeft = rect.left;
                if (spaceRight < subRect.width && spaceLeft > subRect.width) {
                    submenu.style.left = -subRect.width + "px";
                } else {
                    submenu.style.left = rect.width + "px";
                }
                submenu.style.top = "0px";
            }
            submenu.style.display = "";
        }

        function closeAllSubmenus() {
            document.querySelectorAll(".submenu.visible").forEach(sub =>
                sub.classList.remove("visible")
            );
            document.querySelectorAll(".menu-item.active").forEach(item =>
                item.classList.remove("active")
            );
            document.querySelectorAll(".menu-item.focused").forEach(item =>
                item.classList.remove("focused")
            );
            document.querySelectorAll(".menu-item.sub-active").forEach(item =>
                item.classList.remove("sub-active")
            );
            focusedItem = null;
        }

        function focusItem(item) {
            if (!item) return; // Safety check
            if (focusedItem) focusedItem.classList.remove("focused");
            item.classList.add("focused");
            focusedItem = item;
            item.scrollIntoView({ block: "nearest" });
            document.querySelectorAll(".menu-item.sub-active").forEach(el =>
                el.classList.remove("sub-active")
            );
            let ancestor = item.parentElement?.closest(".menu-item");
            while (ancestor) {
                ancestor.classList.add("sub-active");
                ancestor = ancestor.parentElement?.closest(".submenu")?.parentElement?.closest(".menu-item");
            }
        }

        document.addEventListener("click", (e) => {
            if (!e.target.closest(".menu")) {
                closeAllSubmenus();
                activeTopMenu = null;
            }
        });

        document.addEventListener("keydown", (e) => {
            if (!activeTopMenu) return;

            const topItems = topLevelItems;
            const topIndex = topItems.indexOf(activeTopMenu);
            if (topIndex === -1) return;

            let openSubmenu = focusedItem
                ? focusedItem.closest(".submenu")
                : topLevelSubmenus.get(activeTopMenu);

            if (!openSubmenu) return;

            // Handle top-level navigation
            if (!focusedItem || !openSubmenu.contains(focusedItem)) {
                switch (e.key) {
                    case "ArrowRight":
                        e.preventDefault();
                        const nextTop = topItems[(topIndex + 1) % topItems.length];
                        const nextSub = topLevelSubmenus.get(nextTop);
                        if (nextTop && nextSub) {
                            openTopMenu(nextTop, nextSub, 0);
                            focusItem(nextSub.querySelector(".menu-item"));
                        }
                        return;
                    case "ArrowLeft":
                        e.preventDefault();
                        const prevTop = topItems[(topIndex - 1 + topItems.length) % topItems.length];
                        const prevSub = topLevelSubmenus.get(prevTop);
                        if (prevTop && prevSub) {
                            openTopMenu(prevTop, prevSub, 0);
                            focusItem(prevSub.querySelector(".menu-item"));
                        }
                        return;
                    case "ArrowDown":
                        e.preventDefault();
                        const currentSub = topLevelSubmenus.get(activeTopMenu);
                        if (currentSub) {
                            const firstItem = currentSub.querySelector(".menu-item");
                            if (firstItem) focusItem(firstItem);
                        }
                        return;
                    case "Escape":
                        e.preventDefault();
                        closeAllSubmenus();
                        activeTopMenu = null;
                        return;
                }
                return; // stop here if we just handled top-level
            }

            // Handle submenu navigation
            const items = Array.from(openSubmenu.querySelectorAll(":scope > .menu-item"));
            const index = focusedItem ? items.indexOf(focusedItem) : -1;

            switch (e.key) {
                case "ArrowDown":
                    e.preventDefault();
                    if (index < items.length - 1) {
                        focusItem(items[index + 1]);
                    } else {
                        focusItem(items[0]); // Wrap to first item
                    }
                    break;
                case "ArrowUp":
                    e.preventDefault();
                    if (index > 0) {
                        focusItem(items[index - 1]);
                    } else {
                        focusItem(items[items.length - 1]); // Wrap to last item
                    }
                    break;
                case "ArrowRight":
                    e.preventDefault();
                    if (focusedItem?.classList.contains("has-sub")) {
                        const sub = focusedItem.querySelector(":scope > .submenu");
                        if (sub) {
                            positionSubmenu(focusedItem, sub, 1);
                            sub.classList.add("visible");
                            focusItem(sub.querySelector(".menu-item"));
                        }
                    } else {
                        const nextTop = topItems[(topIndex + 1) % topItems.length];
                        const nextSub = topLevelSubmenus.get(nextTop);
                        if (nextTop && nextSub) {
                            openTopMenu(nextTop, nextSub, 0);
                            focusItem(nextSub.querySelector(".menu-item"));
                        }
                    }
                    break;
                case "ArrowLeft":
                    e.preventDefault();
                    const parentMenu = focusedItem.closest(".submenu");
                    const parentItem = parentMenu?.parentElement?.closest(".menu-item");

                    if (parentItem) {
                        parentMenu.classList.remove("visible");
                        focusItem(parentItem);
                    } else {
                        const prevTop = topItems[(topIndex - 1 + topItems.length) % topItems.length];
                        const prevSub = topLevelSubmenus.get(prevTop);
                        if (prevTop && prevSub) {
                            openTopMenu(prevTop, prevSub, 0);
                            focusItem(prevSub.querySelector(".menu-item"));
                        }
                    }
                    break;
                case "Enter":
                case " ":
                    e.preventDefault();
                    if (focusedItem?.classList.contains("has-sub")) {
                        const sub = focusedItem.querySelector(":scope > .submenu");
                        if (sub) {
                            positionSubmenu(focusedItem, sub, 1);
                            sub.classList.add("visible");
                            focusItem(sub.querySelector(".menu-item"));
                            return;
                        }
                    }
                    focusedItem?.click();
                    break;
                case "Escape":
                    e.preventDefault();
                    closeAllSubmenus();
                    activeTopMenu = null;
                    break;
            }
        });

        topLevelItems.length = 0;
        topLevelSubmenus.clear();

        const menuBar = buildMenu(menuData);
        document.body.prepend(menuBar);
    </script>

</body>

</html>